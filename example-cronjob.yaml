---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pvc-backup
  namespace: default
  annotations:
    kustomize.toolkit.fluxcd.io/substitute: disabled
spec:
  schedule: "20 23 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: pbs-backup
              # Use GitHub Container Registry image
              image: ghcr.io/fgeck/pbs-k8s-backup:latest
              command: ["/entrypoint.sh", "pvcs"]
              env:
                - name: PVC_HOST_PATH
                  value: "/pvcs"
                - name: PROXMOX_BACKUP_SERVER_NAMESPACE
                  value: "k3s/pvcs"
              envFrom:
                - secretRef:
                    name: pvc-backup-secret
              volumeMounts:
                - name: pvc-path
                  mountPath: /pvcs
          restartPolicy: Never
          volumes:
            - name: pvc-path
              hostPath:
                path: /opt/k3s/data
                type: Directory

---
# Alternative: PostgreSQL backup cronjob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: default
spec:
  schedule: "30 23 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: pbs-backup
              image: ghcr.io/fgeck/pbs-k8s-backup:latest
              command: ["/entrypoint.sh", "postgres"]
              env:
                - name: BACKUP_NAME
                  value: "default-postgres"
                - name: POSTGRES_HOST
                  value: "postgresql.default.svc.cluster.local"
                - name: POSTGRES_USER
                  value: "postgres"
              envFrom:
                - secretRef:
                    name: postgres-backup-secret
                - secretRef:
                    name: pvc-backup-secret # For PBS credentials
          restartPolicy: Never
